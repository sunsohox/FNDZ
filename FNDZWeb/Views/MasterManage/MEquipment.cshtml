@{
    Master.EntityDAO.MCompanyData lFNDZ_MCompanyData = Master.EntityDefinitions.MCompanyRule.GetCompanyData();
    Layout = null;
}

<!DOCTYPE html>
<html lang="zh">
<head>
    <meta http-equiv="Content-Type" content="text/html;" charset="UTF-8" />
    <title>电梯远程监控系统 - Login</title>
    <link rel="stylesheet" type="text/css" href="../Scripts/jquery-easyui-1.4.1/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../Scripts/jquery-easyui-1.4.1/themes/icon.css">
    <script type="text/javascript" src="../Scripts/jquery.min.js"></script>
    <script type="text/javascript" src="../Scripts/jquery-easyui-1.4.1/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../Scripts/jquery-easyui-1.4.1/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../Scripts/jsoutexcel.js"></script>
    <script type="text/javascript" src="../Scripts/jscommon.js"></script>
    <link href="~/Content/base.css" rel="stylesheet" />
    <script>
        

        var winName;
        $(function () {
            $('#dg').datagrid({
                url: '../MasterManage/MEquipmentList/',
                //toolbar: '#tb', // 工具栏
                striped: true,   //是否显示斑马线效果。
                onDblClickRow: onDblClickRow,// 双击编辑
                rownumbers: true,   //行号
                autoRowHeight: true,//自动高度
                pagination: true,   //是否分页 ， 分页是自动分页的，你在后台可以获取到两个参数，这个自己去获取一下我忘记了叫什么名字了
                pageSize: 20,       //分页条数
                columns: [[
                    // 表头
                    { field: 'EquipmentCode', title: '设备编号', sortable: true, width: 120 },
                    { field: 'EquipmentName', title: '设备名称', sortable: true, width: 150 },
                    { field: 'ProductCode', title: '产品编号', sortable: true, width: 200 },                    
                    {
                        field: 'EquipmentType', title: '设备类型', sortable: true, width: 120,
                        formatter: function (data) {
                            if (data != null) {
                            if (data == 2) return '扶梯';
                            else if (data == 1) return '电梯';
                            else if (data == 3) return '自动人行道';
                            }
                        }

                    },
					{ field: 'Province', title: '省级', sortable: true, width: 100 },
                    { field: 'City', title: '市级', sortable: true, width: 100 },
                    { field: 'County', title: '区/(县级)', sortable: true, width: 100 },
                    { field: 'Village', title: '乡镇', sortable: true, width: 100 },
                    { field: 'State', title: '路段', sortable: true, width: 100 },
					{ field: 'ResidentialArea', title: '小区', sortable: true, width: 100 },
					{ field: 'StreetNumber', title: '门牌号', sortable: true, width: 100 },
					{ field: 'Building', title: '栋', sortable: true, width: 100 },
					{ field: 'Unit', title: '单元', sortable: true, width: 100 },
					{ field: 'LadderNo', title: '梯号', sortable: true, width: 100 },
					{ field: 'ManufacturerName', title: '生产厂家', sortable: true, width: 100 },
					{ field: 'ManufacturerMan', title: '厂家联系人', sortable: true, width: 100 },
					{ field: 'ManufacturerTel', title: '厂家电话', sortable: true, width: 100 },
					{ field: 'ManufacturerAddress', title: '厂家地址', sortable: true, width: 100 },
					{ field: 'ResiAreaName', title: '用户名称', sortable: true, width: 100 },
					{ field: 'ResiAreaDirector', title: '用户联系人', sortable: true, width: 100 },
					{ field: 'ResiAreaDirectorTel', title: '用户电话', sortable: true, width: 100 },
					{ field: 'MaintCompanyName', title: '维保公司', sortable: true, width: 100 },
					{ field: 'MaintCompanyDirector', title: '维保联系人', sortable: true, width: 100 },
					{ field: 'MaintCompanyDirectorTel', title: '维保电话', sortable: true, width: 100 },
					{ field: 'MaintMan1', title: '维保人员1姓名', sortable: true, width: 100 },
					{ field: 'MaintManTel1', title: '维保人员1电话', sortable: true, width: 100 },
					{ field: 'MaintMan2', title: '维保人员2姓名', sortable: true, width: 100 },
					{ field: 'MaintManTel2', title: '维保人员2电话', sortable: true, width: 100 },
					{ field: 'MaintMan3', title: '维保人员3姓名', sortable: true, width: 100 },
					{ field: 'MaintManTel3', title: '维保人员3电话', sortable: true, width: 100 },
					{ field: 'MaintMan4', title: '维保人员4姓名', sortable: true, width: 100 },
					{ field: 'MaintManTel4', title: '维保人员4电话', sortable: true, width: 100 },
					{ field: 'MaintMan5', title: '维保人员5姓名', sortable: true, width: 100 },
					{ field: 'MaintManTel5', title: '维保人员5电话', sortable: true, width: 100 },
                    { field: 'CreateBy', title: '创建人', sortable: true, width: 100 },
                    {
                        field: 'CreateOn', title: '创建时间', sortable: true, width: 150,
                        formatter: function (val) {
                            if (val != null && val != '') {
                                var date = new Date(val);
                                return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + " " + date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
                            }

                        }
                    }
                    ,
                    { field: 'UpdateBy', title: '修改人', sortable: true, width: 100 },
                    {
                        field: 'UpdateOn', title: '修改时间', sortable: true, width: 150,
                        formatter: function (val) {
                            if (val != null && val != '') {
                                var date = new Date(val);
                                return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + " " + date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
                            }

                        }
                    }
                ]]
            });

            //双击编辑
            function onDblClickRow(rowIndex, rowData) {
                $('#dlg').dialog('open').dialog('setTitle', '修改' + winName + '信息');
                $('#dlg-fm').form('load', rowData);
                $('#ProductCode').attr({ 'readOnly': true });
                $("#ProductCode").css("backgroundColor", "#fafafa");
                $('#EquipmentType').combobox('disable');
                $('#btnSave').linkbutton({ text: '保存' });
                url = '../MasterManage/MEquipmentUpdate/' + rowIndex;
            }
                       
        });
        //添加信息
        var url;
        function newRow() {
            $('#dlg').dialog('open').dialog('setTitle', '添加' + winName + '信息');            
            $('#ProductCode').attr({ 'readOnly': false });
            $("#ProductCode").css("backgroundColor", "");
            $('#EquipmentType').combobox("enable");
            $('#dlg-fm').form('clear');
            $('#btnSave').linkbutton({ text: '新建' });
            UpdateNo();
            url = '../MasterManage/MEquipmentSave/';
        }

        //修改信息
        function editRow() {

            var row = $('#dg').datagrid('getSelections');
            if (row.length == 1) {
                if (row[0]) {
                    $('#dlg').dialog('open').dialog('setTitle', '修改' + winName + '信息');
                    $('#dlg-fm').form('load', row[0]);
                    url = '../MasterManage/MEquipmentUpdate/' + row.Id;
                }
            } else {
                $.messager.alert("提示", "每次只能修改一条，请重选");
                return;
            }
        }

        //保存信息
        function saveRow() {
            $('#dlg-fm').form('submit', {
                url: url,
                onSubmit: function () {
                    return $(this).form('validate');
                },
                success: function (result) {
                    if (result == 'Saveok' || result == 'Updateok') {
                        $('#dlg').dialog('close'); 	// 关闭弹出框
                        $('#dg').datagrid('reload'); // reload the user data
                        $('#btnSave').linkbutton({ text: '保存' });
                        $.messager.alert("操作", "操作成功！");
                    }
                    else {
                        $.messager.alert("操作", result);
                        return;
                    }
                }
            });
        }

        //删除
        function removeRow() {
            var row = $('#dg').datagrid('getSelections');
            if (!row || row.length == 0) {
                $.messager.alert('提示', '请选择要删除的数据');
                return;
            }
            var parm;
            $.each(row, function (i, n) {
                if (i == 0) {
                    parm = n.EquipmentCode;
                }
                else {
                    parm += "," + n.EquipmentCode;
                }
            });
            if (row) {
                $.messager.confirm('删除信息', '您确定删除此条信息吗?', function (r) {
                    if (r) {
                        $.post('../MasterManage/MEquipmentDelete/', { idList: parm }, function (result) {
                            if (result.success) {
                                $('#dg').datagrid('reload'); // reload the user data
                                $.messager.alert("提示", "删除成功！");
                            } else {
                                $.messager.alert('提示', '删除失败，请检查！');
                                return;
                            }
                        }, 'json');
                    }
                });
            }
        }       

        //条件查询
        function Searchcheck() {
            var keywords = $("#SearchEquipmentCode").val();
            $('#dg').datagrid('load', {
                EquipmentCode: keywords
            });
        }
        function clearSearch() {
            $('#fm').form('clear');
        }
        $(function () {
            winName = "设备";
            $('#btnSearch').click(function () { Searchcheck(); });
            $('#btnClear').click(function () { clearSearch(); });
            $('#btnAdd').click(function () { newRow(); });
            $('#btnDel').click(function () { removeRow(); });
            $('#btnSave').click(function () { saveRow(); });
            $('#export_item').click(function () { Save_Excel(); });            
            //查询界面伸缩
            SetInfoShowPosi();
        });

        $(document).ready(function () {
            $("#drpManufacturerName").combobox({
                onChange: function (n, o) {
                    $.ajax({
                        url: "@Html.Raw(Url.Action("GetMCompany", "MasterManage"))",
                        dataType: "text",
                        data: { CompanyCode: n },
                        success: function (data) {
                            var r = eval('(' + data + ')');
                            $('#ManufacturerMan').val(r.ContactMan);
                            $('#ManufacturerTel').val(r.Tel);
                            $('#ManufacturerAddress').val(r.Address);
                        }
                    })

                }
            });


            $("#drpMaintCompanyName").combobox({
                onChange: function (n, o) {
                    $.ajax({
                        url: "@Html.Raw(Url.Action("GetMCompany", "MasterManage"))",
                        dataType: "text",
                        data: { CompanyCode: n },
                        success: function (data) {
                            var r = eval('(' + data + ')');
                            $('#MaintCompanyDirector').val(r.ContactMan);
                            $('#MaintCompanyDirectorTel').val(r.Tel);
                        }
                    })

                }
            });
        });


        //获取编号
        function UpdateNo() {
            var t = new Date().getTime();
            $.ajax({
                url: "@Html.Raw(Url.Action("GetSequence", "MasterManage"))" + '?t=' + t,
                dataType: "text",
                data: { SequenceCode: 'EquipmentCode', BhCode: 'SBDM' },
                success: function (data) {
                    $("#EquipmentCode").val(data);
                }
            });
        }
    </script>
    
</head>
<body>

    <table style="width:100%">
        <tr id="trShowSeach">
            <td>
                <div style="height:auto;">
		            <div id="pInfoShow" class="easyui-panel"  style="overflow:auto; width:100%;padding:10px;"
				            data-options="title:'查询操作',collapsible:true">
                        <form id="fm" method="post" novalidate>	
			                <table style="width:100%">
                                <tbody>
                                      <tr>
                                        <td style="width:100px;"><label>设备编号：</label></td>
                                        <td>
                                            <input class="easyui-validatebox   textbox" style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="SearchEquipmentCode" name="SearchEquipmentCode" />
                                        </td>
                                        <td colspan="4">
                                            <a id="btnSearch" class="easyui-linkbutton" icon="icon-search" href="javascript:void(0)">查询</a> 
                                            <a id="btnClear" class="easyui-linkbutton" icon="icon-clear" href="javascript:void(0)" >清空</a>  &nbsp;&nbsp;&nbsp;&nbsp;
                                            <a id="btnAdd" class="easyui-linkbutton" icon="icon-add" href="javascript:void(0)">新建</a>
                                            <a id="btnDel" class="easyui-linkbutton" icon="icon-remove" href="javascript:void(0)" >删除</a> 
                                            <a id="export_item" class="easyui-linkbutton" icon="icon-ext" href="javascript:void(0)">Excel导出</a> 
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                         </form>
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <td>
                <table id="dg" style="overflow-y: hidden;width:100%"  sortName= "EquipmentCode"></table>
            </td>
         </tr>
    </table>

<!--Mgr窗体-->
<div id="dlg" class="easyui-dialog" style="width:1100px;height:450px;padding:10px 20px"
		closed="true" buttons="#dlg-buttons">
	<form id="dlg-fm" method="post" novalidate>
        <table class="default-tab1">
            <tr>
                <td  class="tac w100">基本信息</td>
                <td style="width:80px;text-align:right;">设备编号：</td>
                <td><input class="easyui-validatebox  textbox" style="padding-top:3px;padding-bottom:3px;width: 120px;background-color:#fafafa" readonly="true" type="text" id="EquipmentCode" name="EquipmentCode" /></td>
                <td style="width:80px;text-align:right;">设备名称：</td>
                <td><input class="easyui-validatebox  textbox "  data-options="required:true" style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="EquipmentName" name="EquipmentName" /></td>
                <td style="width:80px;text-align:right;">产品编号：</td>
                <td><input class="easyui-validatebox  textbox "  data-options="required:true" style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="ProductCode" name="ProductCode" /></td>
                <td style="width:80px;text-align:right;">设备类型：</td>
                <td>
                    <select class="easyui-combobox" data-options="required:true" style="width: 120px" id="EquipmentType" name="EquipmentType">
                    <option value="1">电梯</option>  
                    <option value="2">扶梯</option>  
                    <option value="3">自动人行道</option>
                    </select>
                </td>
            </tr> 
            <tr>
                <td  class="tac w100" rowspan="3">设备地址</td>
                <td style="text-align:right;">省级：</td>
                <td><input class="easyui-validatebox  textbox" style="padding-top:3px;padding-bottom:3px;width: 120px;"  type="text" id="Province" name="Province" /></td>
                <td style="text-align:right;">市级：</td>
                <td><input class="easyui-validatebox  textbox " style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="City" name="City" /></td>
                <td style="text-align:right;">区/(县级)：</td>
                <td><input class="easyui-validatebox  textbox" style="padding-top:3px;padding-bottom:3px;width: 120px;"  type="text" id="County" name="County" /></td>
                <td style="text-align:right;">乡镇：</td>
                <td><input class="easyui-validatebox  textbox " style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="Village" name="Village" /></td>
            </tr> 
            <tr>
                <td style="text-align:right;">路段：</td>
                <td><input class="easyui-validatebox  textbox" style="padding-top:3px;padding-bottom:3px;width: 120px;"  type="text" id="State" name="State" /></td>
                <td style="text-align:right;">小区：</td>
                <td><input class="easyui-validatebox  textbox " style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="ResidentialArea" name="ResidentialArea" /></td>
                <td style="text-align:right;">门牌号：</td>
                <td><input class="easyui-validatebox  textbox" style="padding-top:3px;padding-bottom:3px;width: 120px;"  type="text" id="StreetNumber" name="StreetNumber" /></td>
                <td style="text-align:right;">栋：</td>
                <td><input class="easyui-validatebox  textbox " style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="Building" name="Building" /></td>
            </tr> 
            <tr>
                <td style="text-align:right;">单元：</td>
                <td><input class="easyui-validatebox  textbox" style="padding-top:3px;padding-bottom:3px;width: 120px;"  type="text" id="Unit" name="Unit" /></td>
                <td style="text-align:right;">梯号：</td>
                <td><input class="easyui-validatebox  textbox " style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="LadderNo" name="LadderNo" /></td>
                <td colspan="4"></td>
            </tr>
            <tr>
                <td  class="tac w100">厂家信息</td>
                <td style="text-align:right;">生产厂家：</td>
                <td><select class="easyui-combobox"  id="drpManufacturerName" style="width:120px;">
                        @{
                            foreach (Master.EntityDAO.MCompanyData.MCompanyRow MCompany_row in lFNDZ_MCompanyData.MCompany.Select("CompanyType='1'"))
                                {
                            <option value="@MCompany_row.CompanyCode">@MCompany_row.CompanyName</option>  
                                }
                        }
                    </select></td>
                <td style="text-align:right;">厂家联系人：</td>
                <td><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="ManufacturerMan" name="ManufacturerMan" /></td>
                <td style="text-align:right;">厂家电话：</td>
                <td><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="ManufacturerTel" name="ManufacturerTel" /></td>
                <td style="text-align:right;">厂家地址：</td>
                <td><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="ManufacturerAddress" name="ManufacturerAddress" /></td>
            </tr>
            <tr>
                <td  class="tac w100">用户信息</td>
                <td style="text-align:right;">用户名称：</td>
                <td><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="ResiAreaName" name="ResiAreaName" /></td>
                <td style="text-align:right;">用户联系人：</td>
                <td><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="ResiAreaDirector" name="ResiAreaDirector" /></td>
                <td style="text-align:right;">用户电话：</td>
                <td colspan="3"><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="ResiAreaDirectorTel" name="ResiAreaDirectorTel" /></td>
                
            </tr> 
            <tr>
                <td  class="tac w100" rowspan="4">维保信息</td>
                <td style="text-align:right;">维保公司：</td>
                <td><select class="easyui-combobox"  id="drpMaintCompanyName" style="width:120px;">
                                    @{
                                        foreach (Master.EntityDAO.MCompanyData.MCompanyRow MCompany_row in lFNDZ_MCompanyData.MCompany.Select("CompanyType='3'"))
                                            {
                                        <option value="@MCompany_row.CompanyCode">@MCompany_row.CompanyName</option>  
                                            }
                                    }
                                </select></td>
                <td style="text-align:right;">维保联系人：</td>
                <td><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="MaintCompanyDirector" name="MaintCompanyDirector" /></td>
                <td style="text-align:right;">维保电话：</td>
                <td><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="MaintCompanyDirectorTel" name="MaintCompanyDirectorTel" /></td>
                <td style="text-align:right;"></td>
                <td></td>
            </tr>
            <tr>
                <td style="text-align:right;">人员1姓名：</td>
                <td><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="MaintMan1" name="MaintMan1" /></td>
                <td style="text-align:right;">人员1电话：</td>
                <td><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="MaintManTel1" name="MaintManTel1" /></td>
                <td style="text-align:right;">人员2姓名：</td>
                <td><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="MaintMan2" name="MaintMan2" /></td>
                <td style="text-align:right;">人员2电话：</td>
                <td><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="MaintManTel2" name="MaintManTel2" /></td>
            </tr>
            <tr>
                <td style="text-align:right;">人员3姓名：</td>
                <td><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="MaintMan3" name="MaintMan3" /></td>
                <td style="text-align:right;">人员3电话：</td>
                <td><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="MaintManTel3" name="MaintManTel3" /></td>
                <td style="text-align:right;">人员4姓名：</td>
                <td><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="MaintMan4" name="MaintMan4" /></td>
                <td style="text-align:right;">人员4电话：</td>
                <td><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="MaintManTel4" name="MaintManTel4" /></td>
            </tr>
             <tr>
                <td style="text-align:right;">人员5姓名：</td>
                <td><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="MaintMan5" name="MaintMan5" /></td>
                <td style="text-align:right;">人员5电话：</td>
                <td colspan="5"><input class="easyui-validatebox  textbox "  style="padding-top:3px;padding-bottom:3px;width: 120px;" type="text" id="MaintManTel5" name="MaintManTel5" /></td>
            </tr>

            <tr>
                <td  class="tac w100">其他</td>
                <td style="text-align:right;">备注：</td>
                <td colspan="7"><textarea class="easyui-validatebox"  style="height:20px;width:700px;" name="Remark" id="Remark"></textarea></td>
            </tr>      
        </table>		
	</form>
</div>
<div id="dlg-buttons">
	<a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-ok" id="btnSave">确定</a>
	<a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" onclick="javascript:$('#dlg').dialog('close')">关闭</a>
</div> 
</body>
</html>
